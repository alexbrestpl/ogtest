# Миграция базы данных

## Обновление расположения базы данных

В версии после коммита от 2025-01-XX база данных была перемещена из `backend/statistics.db` в `backend/src/config/statistics.db`.

### Для существующих установок

Если у вас уже есть работающее приложение с данными в старом расположении, выполните миграцию:

#### Вариант 1: Автоматическая миграция через deploy.sh

При следующем запуске `./deploy.sh` миграция произойдет автоматически:
- Старая БД будет перемещена в новое расположение
- Схема будет обновлена для новых полей
- Все данные сохранятся

```bash
./deploy.sh
```

#### Вариант 2: Ручная миграция

Если вы хотите выполнить миграцию вручную перед деплоем:

```bash
cd backend
npm run migrate:db-location
```

Скрипт автоматически:
1. Создаст директорию `src/config` если её нет
2. Создаст резервную копию старой БД с временной меткой
3. Переместит БД в новое расположение
4. Обновит схему для новых полей (session_token, question_ids, etc.)

### Для новых установок

Новые установки автоматически создадут БД в правильном расположении при первом запуске миграций:

```bash
cd backend
npm run migrate:questions
```

### Откат изменений

Если что-то пошло не так, вы можете восстановить данные из резервной копии:

```bash
cd backend
# Найдите резервную копию (файл вида statistics.db.backup.YYYYMMDD_HHMMSS)
ls -la statistics.db.backup.*

# Восстановите из резервной копии
cp statistics.db.backup.YYYYMMDD_HHMMSS statistics.db
```

### Проверка статуса

После миграции убедитесь, что:
1. Файл `backend/src/config/statistics.db` существует
2. Приложение запускается без ошибок
3. Статистика отображается корректно на `/stats`

```bash
# Проверка наличия БД
ls -lh backend/src/config/statistics.db

# Запуск приложения
cd backend
npm start

# Или через PM2
pm2 restart ogtest
pm2 logs ogtest
```

### Важные замечания

⚠️ **Не удаляйте** резервную копию `statistics.db.backup.*` до тех пор, пока не убедитесь, что приложение работает корректно с новым расположением БД.

⚠️ При обновлении через **Docker** убедитесь, что volume указывает на правильный путь:
```yaml
volumes:
  - ./backend/src/config/statistics.db:/app/src/config/statistics.db
```

## Обновление схемы базы данных

Для добавления новых полей в существующую БД (без изменения расположения):

```bash
cd backend
npm run migrate:db
```

Это добавит недостающие столбцы:
- `session_token` - токен аутентификации сессии
- `question_ids` - список вопросов в JSON
- `current_question_index` - индекс текущего вопроса
- `focus_switches` - счетчик переключений фокуса
