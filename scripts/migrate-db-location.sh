#!/bin/bash
set -e

echo "üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–æ–≤–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é backend
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
cd "$PROJECT_DIR/backend"

OLD_DB_PATH="statistics.db"
NEW_DB_PATH="src/config/statistics.db"
NEW_DB_DIR="src/config"
BACKUP_PATH="statistics.db.backup.$(date +%Y%m%d_%H%M%S)"

echo -e "${BLUE}üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)${NC}"
echo ""

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ë–î –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if [ ! -d "$NEW_DB_DIR" ]; then
    echo -e "${BLUE}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $NEW_DB_DIR...${NC}"
    mkdir -p "$NEW_DB_DIR"
    echo -e "${GREEN}‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞—Ä–æ–π –ë–î
if [ -f "$OLD_DB_PATH" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–∞—Ä–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏: $OLD_DB_PATH${NC}"

    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
    echo -e "${BLUE}üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...${NC}"
    cp "$OLD_DB_PATH" "$BACKUP_PATH"
    echo -e "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_PATH${NC}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –Ω–æ–≤–∞—è –ë–î
    if [ -f "$NEW_DB_PATH" ]; then
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –Ω–æ–≤–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏!${NC}"
        echo -e "${YELLOW}   –°—Ç–∞—Ä–∞—è –ë–î: $OLD_DB_PATH${NC}"
        echo -e "${YELLOW}   –ù–æ–≤–∞—è –ë–î: $NEW_DB_PATH${NC}"
        echo -e "${YELLOW}   –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $BACKUP_PATH${NC}"
        echo ""
        echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Ä—É—á–Ω—É—é —Ä–µ—à–∏—Ç–µ, –∫–∞–∫—É—é –ë–î –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å."
        exit 1
    fi

    # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ë–î
    echo -e "${BLUE}üîÑ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
    mv "$OLD_DB_PATH" "$NEW_DB_PATH"
    echo -e "${GREEN}‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞: $OLD_DB_PATH -> $NEW_DB_PATH${NC}"

    # –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å—Ö–µ–º—ã
    echo ""
    echo -e "${BLUE}üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
    npm run migrate:db

    echo ""
    echo -e "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo -e "${BLUE}üìä –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: $BACKUP_PATH${NC}"
    echo -e "${YELLOW}   –í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å –µ—ë –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.${NC}"

elif [ -f "$NEW_DB_PATH" ]; then
    echo -e "${GREEN}‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏: $NEW_DB_PATH${NC}"
    echo ""
    echo -e "${BLUE}üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã...${NC}"
    npm run migrate:db

else
    echo -e "${YELLOW}‚ö†Ô∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∏ –≤ —Å—Ç–∞—Ä–æ–º, –Ω–∏ –≤ –Ω–æ–≤–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏.${NC}"
    echo -e "${BLUE}   –ó–∞–ø—É—Å—Ç–∏—Ç–µ npm run migrate:questions –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –ë–î.${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ!${NC}"
